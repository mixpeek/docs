---
title: "Structured Filter"
description: "Filter documents using metadata field conditions and boolean logic"
---

<Frame>
  <img src="/assets/retrievers/structured-filter.svg" alt="Structured Filter stage showing metadata-based document filtering" />
</Frame>

The Structured Filter stage filters documents based on metadata field conditions. It supports comparison operators, array operations, and boolean logic for precise document selection.

<Note>
  **Stage Category**: FILTER (Reduces document set)

  **Transformation**: N documents → M documents (where M ≤ N)
</Note>

## When to Use

| Use Case | Description |
|----------|-------------|
| **Metadata filtering** | Filter by category, status, date range |
| **Access control** | Filter by user permissions or tenant |
| **Post-search refinement** | Narrow results after semantic search |
| **Faceted filtering** | Apply user-selected facet filters |

## When NOT to Use

| Scenario | Recommended Alternative |
|----------|------------------------|
| Content-based filtering | `llm_filter` |
| Pre-filtering in search | Use `filters` param in search stage |
| Complex business logic | `api_call` to external service |

## Parameters

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `conditions` | object | *Required* | Filter conditions (single or compound) |

## Operators

### Comparison Operators

| Operator | Description | Example |
|----------|-------------|---------|
| `eq` | Equals | `{"operator": "eq", "value": "active"}` |
| `neq` | Not equals | `{"operator": "neq", "value": "deleted"}` |
| `gt` | Greater than | `{"operator": "gt", "value": 100}` |
| `gte` | Greater or equal | `{"operator": "gte", "value": 0}` |
| `lt` | Less than | `{"operator": "lt", "value": 1000}` |
| `lte` | Less or equal | `{"operator": "lte", "value": 99.99}` |

### String Operators

| Operator | Description | Example |
|----------|-------------|---------|
| `contains` | Contains substring | `{"operator": "contains", "value": "premium"}` |
| `starts_with` | Starts with | `{"operator": "starts_with", "value": "doc_"}` |
| `ends_with` | Ends with | `{"operator": "ends_with", "value": ".pdf"}` |
| `regex` | Regex match | `{"operator": "regex", "value": "^[A-Z]{3}-\\d+$"}` |

### Array Operators

| Operator | Description | Example |
|----------|-------------|---------|
| `in` | Value in array | `{"operator": "in", "value": ["a", "b", "c"]}` |
| `not_in` | Value not in array | `{"operator": "not_in", "value": ["x", "y"]}` |
| `contains_any` | Array contains any | `{"operator": "contains_any", "value": ["tag1", "tag2"]}` |
| `contains_all` | Array contains all | `{"operator": "contains_all", "value": ["required1", "required2"]}` |

### Existence Operators

| Operator | Description | Example |
|----------|-------------|---------|
| `exists` | Field exists | `{"operator": "exists", "value": true}` |
| `is_null` | Field is null | `{"operator": "is_null", "value": true}` |

## Configuration Examples

<CodeGroup>
```json Simple Equality
{
  "stage_type": "filter",
  "stage_id": "structured_filter",
  "parameters": {
    "conditions": {
      "field": "metadata.status",
      "operator": "eq",
      "value": "published"
    }
  }
}
```

```json Range Filter
{
  "stage_type": "filter",
  "stage_id": "structured_filter",
  "parameters": {
    "conditions": {
      "AND": [
        {"field": "metadata.price", "operator": "gte", "value": 10},
        {"field": "metadata.price", "operator": "lte", "value": 100}
      ]
    }
  }
}
```

```json Multiple Categories (OR)
{
  "stage_type": "filter",
  "stage_id": "structured_filter",
  "parameters": {
    "conditions": {
      "OR": [
        {"field": "metadata.category", "operator": "eq", "value": "electronics"},
        {"field": "metadata.category", "operator": "eq", "value": "computers"}
      ]
    }
  }
}
```

```json In Array
{
  "stage_type": "filter",
  "stage_id": "structured_filter",
  "parameters": {
    "conditions": {
      "field": "metadata.category",
      "operator": "in",
      "value": ["electronics", "computers", "accessories"]
    }
  }
}
```

```json Complex Boolean Logic
{
  "stage_type": "filter",
  "stage_id": "structured_filter",
  "parameters": {
    "conditions": {
      "AND": [
        {"field": "metadata.in_stock", "operator": "eq", "value": true},
        {
          "OR": [
            {"field": "metadata.category", "operator": "eq", "value": "sale"},
            {"field": "metadata.discount_pct", "operator": "gt", "value": 0}
          ]
        },
        {"field": "metadata.price", "operator": "lte", "value": "{{INPUT.max_price}}"}
      ]
    }
  }
}
```

```json Tag Filtering
{
  "stage_type": "filter",
  "stage_id": "structured_filter",
  "parameters": {
    "conditions": {
      "AND": [
        {"field": "metadata.tags", "operator": "contains_any", "value": ["featured", "bestseller"]},
        {"field": "metadata.tags", "operator": "not_in", "value": ["discontinued"]}
      ]
    }
  }
}
```

```json Date Range
{
  "stage_type": "filter",
  "stage_id": "structured_filter",
  "parameters": {
    "conditions": {
      "AND": [
        {"field": "metadata.created_at", "operator": "gte", "value": "2024-01-01T00:00:00Z"},
        {"field": "metadata.created_at", "operator": "lt", "value": "2024-12-31T23:59:59Z"}
      ]
    }
  }
}
```

```json Nested Field Access
{
  "stage_type": "filter",
  "stage_id": "structured_filter",
  "parameters": {
    "conditions": {
      "field": "metadata.author.verified",
      "operator": "eq",
      "value": true
    }
  }
}
```
</CodeGroup>

## Boolean Logic

### AND (All conditions must match)

```json
{
  "AND": [
    {"field": "status", "operator": "eq", "value": "active"},
    {"field": "score", "operator": "gte", "value": 0.5}
  ]
}
```

### OR (Any condition must match)

```json
{
  "OR": [
    {"field": "tier", "operator": "eq", "value": "premium"},
    {"field": "tier", "operator": "eq", "value": "enterprise"}
  ]
}
```

### NOT (Negate a condition)

```json
{
  "NOT": {
    "field": "status",
    "operator": "eq",
    "value": "deleted"
  }
}
```

### Nested Logic

```json
{
  "AND": [
    {"field": "active", "operator": "eq", "value": true},
    {
      "OR": [
        {"field": "region", "operator": "eq", "value": "US"},
        {"field": "region", "operator": "eq", "value": "EU"}
      ]
    }
  ]
}
```

## Template Variables

Use template variables for dynamic filtering:

| Variable | Description |
|----------|-------------|
| `{{INPUT.*}}` | Input parameters from retriever call |
| `{{DOC.*}}` | Not available (filtering, not transforming) |

```json
{
  "conditions": {
    "AND": [
      {"field": "metadata.tenant_id", "operator": "eq", "value": "{{INPUT.tenant_id}}"},
      {"field": "metadata.category", "operator": "in", "value": "{{INPUT.categories}}"}
    ]
  }
}
```

## Performance

| Metric | Value |
|--------|-------|
| **Latency** | < 5ms |
| **Index usage** | Automatic when available |
| **In-memory** | For small result sets |
| **Parallel** | Automatic batching |

<Tip>
  For best performance, apply structured filters early in the pipeline to reduce the document set before expensive operations like reranking or LLM calls.
</Tip>

## Common Pipeline Patterns

### Search + Filter + Rerank

```json
[
  {
    "stage_type": "filter",
    "stage_id": "semantic_search",
    "parameters": {
      "query": "{{INPUT.query}}",
      "vector_index": "text_extractor_v1_embedding",
      "top_k": 100
    }
  },
  {
    "stage_type": "filter",
    "stage_id": "structured_filter",
    "parameters": {
      "conditions": {
        "AND": [
          {"field": "metadata.status", "operator": "eq", "value": "active"},
          {"field": "metadata.category", "operator": "in", "value": "{{INPUT.categories}}"}
        ]
      }
    }
  },
  {
    "stage_type": "sort",
    "stage_id": "rerank",
    "parameters": {
      "model": "bge-reranker-v2-m3",
      "top_n": 10
    }
  }
]
```

### Multi-Tenant Filtering

```json
[
  {
    "stage_type": "filter",
    "stage_id": "hybrid_search",
    "parameters": {
      "query": "{{INPUT.query}}",
      "vector_index": "text_extractor_v1_embedding",
      "top_k": 50,
      "filters": {
        "field": "metadata.tenant_id",
        "operator": "eq",
        "value": "{{INPUT.tenant_id}}"
      }
    }
  },
  {
    "stage_type": "filter",
    "stage_id": "structured_filter",
    "parameters": {
      "conditions": {
        "field": "metadata.access_level",
        "operator": "in",
        "value": "{{INPUT.user_access_levels}}"
      }
    }
  }
]
```

## Error Handling

| Error | Behavior |
|-------|----------|
| Invalid field path | Stage fails |
| Type mismatch | Comparison fails, document excluded |
| Invalid operator | Stage fails |
| Empty conditions | All documents pass |

## Related

- [LLM Filter](/retrieval/stages/llm-filter) - Content-based filtering
- [Semantic Search](/retrieval/stages/semantic-search) - Pre-filtering in search
- [Hybrid Search](/retrieval/stages/hybrid-search) - Combined search with filters
